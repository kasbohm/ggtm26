<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√•pings Mallorca - Mobile</title>
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kasbohm.github.io/ggtm26/mobile.html">
    <meta property="og:title" content="G√•pings Mallorca Getaway 2026 - Mobile">
    <meta property="og:description" content="Velg dine ruter, planlegg dagene og gj√∏r deg klar for en episk G√•pingtur p√• Mallorca i 2026! Elite eller mosjonist, eller kombiner!">
    <meta property="og:image" content="https://kasbohm.github.io/ggtm26/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kasbohm.github.io/ggtm26/mobile.html">
    <meta property="twitter:title" content="G√•pings Mallorca Getaway 2026">
    <meta property="twitter:description" content="Velg dine ruter, planlegg dagene og gj√∏r deg klar for en episk G√•pingtur p√• Mallorca i 2026! Elite eller mosjonist, eller kombiner!">
    <meta property="twitter:image" content="https://kasbohm.github.io/ggtm26/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            height: 100vh; 
            overflow: hidden;
            background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        /* Splash */
        .splash { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; padding: 20px; }
        .splash.hidden { opacity: 0; pointer-events: none; }
        .splash img { width: 95%; max-width: 600px; height: auto; }
        .splash-bar { width: 85%; max-width: 500px; height: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-top: 3rem; overflow: hidden; }
        .splash-fill { height: 100%; background: linear-gradient(90deg, #00f5ff, #ff00ff, #ffaa00); background-size: 200%; animation: shimmer 2s linear infinite; transition: width 0.3s; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .splash-text { color: #00f5ff; font-size: 1rem; margin-top: 1.5rem; text-shadow: 0 0 10px rgba(0,245,255,0.8); text-align: center; padding: 0 20px; }
        
        /* Menu */
        .menu-btn { position: fixed; top: 10px; right: 10px; z-index: 2000; width: 50px; height: 50px; background: linear-gradient(135deg, #ff00ff, #ff0080); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; cursor: pointer; box-shadow: 0 4px 15px rgba(255,0,255,0.6); border: 2px solid #ff00ff; }
        .menu-btn span { width: 25px; height: 3px; background: white; transition: 0.3s; box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        
        .menu { position: fixed; top: 0; right: -100%; width: 280px; height: 100vh; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); z-index: 1999; transition: right 0.3s; padding: 70px 20px 20px; overflow-y: auto; border-left: 2px solid #00f5ff; box-shadow: -4px 0 20px rgba(0,245,255,0.3); }
        .menu.active { right: 0; }
        .menu-item { background: linear-gradient(135deg, #302b63, #24243e); color: #00f5ff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 2px solid #00f5ff; width: 100%; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,245,255,0.3); transition: all 0.3s; }
        .menu-item:active { transform: scale(0.95); box-shadow: 0 6px 15px rgba(0,245,255,0.5); }
        
        /* Map */
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 180px; z-index: 1; }
        
        /* Day Swiper */
        .day-swiper { position: fixed; bottom: 0; left: 0; right: 0; height: 180px; background: linear-gradient(180deg, rgba(26,26,46,0.95) 0%, rgba(22,33,62,0.98) 100%); box-shadow: 0 -4px 20px rgba(255,0,255,0.3); border-top: 2px solid #ff00ff; z-index: 1000; overflow: hidden; }
        .day-cards { display: flex; height: 100%; transition: transform 0.3s; }
        .day-card { min-width: 100%; padding: 15px; display: flex; flex-direction: column; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .day-title { font-weight: 700; font-size: 1.2rem; color: #00f5ff; text-shadow: 0 0 10px rgba(0,245,255,0.8); }
        .day-stats { font-size: 0.95rem; color: #ffaa00; text-shadow: 0 0 5px rgba(255,170,0,0.6); }
        .day-select-btn { background: linear-gradient(135deg, #ffaa00, #ff8800); border: 2px solid #ffaa00; color: #0a0a0a; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(255,170,0,0.4); }
        .day-routes { display: flex; gap: 8px; overflow-x: auto; flex: 1; margin-top: 8px; }
        .route-chip { padding: 10px 14px; background: linear-gradient(135deg, rgba(48,43,99,0.8), rgba(36,36,62,0.8)); border-radius: 20px; font-size: 0.8rem; white-space: nowrap; border-left: 3px solid; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        .day-dots { display: flex; justify-content: center; gap: 10px; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .dot { width: 10px; height: 10px; background: rgba(189,195,199,0.3); border-radius: 50%; border: 2px solid #00f5ff; cursor: pointer; transition: all 0.3s; }
        .dot.active { background: #00f5ff; box-shadow: 0 0 10px rgba(0,245,255,0.8); transform: scale(1.2); }
        
        /* FAB */
        .fab-group { position: fixed; bottom: 200px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 2001; }
        .fab { width: 56px; height: 56px; background: linear-gradient(135deg, #00f5ff, #0080ff); border-radius: 50%; border: 2px solid #00f5ff; color: #0a0a0a; font-size: 1.5rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,245,255,0.6); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .fab:active { transform: scale(0.9); }
        .fab.select { background: linear-gradient(135deg, #ffaa00, #ff8800); border-color: #ffaa00; box-shadow: 0 4px 15px rgba(255,170,0,0.6); }
        .fab.download { background: linear-gradient(135deg, #00ff88, #00cc66); border-color: #00ff88; box-shadow: 0 4px 15px rgba(0,255,136,0.6); }
        
        /* Route Selector Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: linear-gradient(180deg, #1a1a2e, #16213e); border: 2px solid #00f5ff; border-radius: 12px; max-width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px; box-shadow: 0 0 40px rgba(0,245,255,0.5); }
        .modal-header { color: #00f5ff; font-size: 1.3rem; font-weight: 700; margin-bottom: 15px; text-shadow: 0 0 10px rgba(0,245,255,0.8); text-align: center; }
        .route-selector { display: flex; flex-direction: column; gap: 10px; }
        .route-option { display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: rgba(48,43,99,0.5); border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .route-option.selected { background: rgba(0,245,255,0.2); border-color: #00f5ff; box-shadow: 0 0 15px rgba(0,245,255,0.4); }
        .route-option input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; accent-color: #00f5ff; flex-shrink: 0; }
        .route-option label { flex: 1; color: white; font-size: 0.85rem; cursor: pointer; }
        .route-name { font-weight: 700; color: #00f5ff; margin-bottom: 4px; }
        .route-details { font-size: 0.75rem; color: #ffaa00; }
        .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 8px; border: 2px solid; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .modal-btn.save { background: linear-gradient(135deg, #00ff88, #00cc66); border-color: #00ff88; color: #0a0a0a; }
        .modal-btn.cancel { background: transparent; border-color: #ff0080; color: #ff0080; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash" id="splash">
        <img src="logo.png" alt="G√•pings Mallorca">
        <div class="splash-bar"><div class="splash-fill" id="splashFill" style="width:0%"></div></div>
        <div class="splash-text" id="splashText">Initializing...</div>
    </div>
    
    <!-- Hamburger Menu -->
    <div class="menu-btn" id="menuBtn"><span></span><span></span><span></span></div>
    <div class="menu" id="menu">
        <button class="menu-item" onclick="autoMakeElite(); closeMenu();">‚ö° Auto Elite (A)</button>
        <button class="menu-item" onclick="autoMakeMosjonist(); closeMenu();">üö¥ Auto Mosjonist (B)</button>
        <button class="menu-item" onclick="document.getElementById('gpxInput').click();">üìÅ Last opp GPX</button>
        <button class="menu-item" onclick="clearAll(); closeMenu();">üóëÔ∏è Fjern alle</button>
    </div>
    <input type="file" id="gpxInput" accept=".gpx" multiple style="display:none">
    
    <!-- Map -->
    <div id="map"></div>
    
    <!-- FAB Buttons -->
    <div class="fab-group">
        <button class="fab download" onclick="downloadCurrentDay()">‚¨áÔ∏è</button>
    </div>
    
    <!-- Route Selector Modal -->
    <div class="modal" id="routeModal">
        <div class="modal-content">
            <div class="modal-header">Velg ruter for <span id="modalDayTitle">Dag 1</span></div>
            <div class="route-selector" id="routeSelector"></div>
            <div class="modal-actions">
                <button class="modal-btn save" onclick="saveRouteSelection()">Lagre</button>
                <button class="modal-btn cancel" onclick="closeRouteSelector()">Avbryt</button>
            </div>
        </div>
    </div>
    
    <!-- Day Swiper -->
    <div class="day-swiper">
        <div class="day-cards" id="dayCards">
            <div class="day-card" style="border-top: 4px solid #e74c3c;">
                <div class="day-header">
                    <span class="day-title">Dag 1 - Port de Soller</span>
                    <button class="day-select-btn" onclick="openRouteSelector()">Velg ruter</button>
                </div>
                <div class="day-stats" id="day1stats"></div>
                <div class="day-routes" id="day1routes"></div>
            </div>
            <div class="day-card" style="border-top: 4px solid #3498db;">
                <div class="day-header">
                    <span class="day-title">Dag 2 - Cap de Formentor</span>
                    <button class="day-select-btn" onclick="openRouteSelector()">Velg ruter</button>
                </div>
                <div class="day-stats" id="day2stats"></div>
                <div class="day-routes" id="day2routes"></div>
            </div>
            <div class="day-card" style="border-top: 4px solid #2ecc71;">
                <div class="day-header">
                    <span class="day-title">Dag 3 - Sa Calobra</span>
                    <button class="day-select-btn" onclick="openRouteSelector()">Velg ruter</button>
                </div>
                <div class="day-stats" id="day3stats"></div>
                <div class="day-routes" id="day3routes"></div>
            </div>
            <div class="day-card" style="border-top: 4px solid #f39c12;">
                <div class="day-header">
                    <span class="day-title">Dag 4 - Puig Major</span>
                    <button class="day-select-btn" onclick="openRouteSelector()">Velg ruter</button>
                </div>
                <div class="day-stats" id="day4stats"></div>
                <div class="day-routes" id="day4routes"></div>
            </div>
        </div>
        <div class="day-dots" id="dayDots">
            <div class="dot active" onclick="goToDay(0)"></div>
            <div class="dot" onclick="goToDay(1)"></div>
            <div class="dot" onclick="goToDay(2)"></div>
            <div class="dot" onclick="goToDay(3)"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inline common code for mobile
        const routes = [];
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b'];
        const dayColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
        const days = [
            { id: 1, name: 'Dag 1', routes: [], visible: true, color: dayColors[0] },
            { id: 2, name: 'Dag 2', routes: [], visible: true, color: dayColors[1] },
            { id: 3, name: 'Dag 3', routes: [], visible: true, color: dayColors[2] },
            { id: 4, name: 'Dag 4', routes: [], visible: true, color: dayColors[3] }
        ];

        const bundledRouteFiles = [
            'GGTM26_D1_A_Helios_Port_de_Soller_107km_1800hm.gpx',
            'GGTM26_D1_A_Port_de_Soller_Helios_87km_1500hm.gpx',
            'GGTM26_D1_B_Helios_Port_de_Soller_66km_1000hm.gpx',
            'GGTM26_D1_B1_Port_de_Soller_Helios_40km_500hm.gpx',
            'GGTM26_D1_B2_Port_de_Soller_Helios_60km_1100hm.gpx',
            'GGTM26_D2_A_Cap_de_Formentor_Helios_125km_1300hm.gpx',
            'GGTM26_D2_A_Helios_Cap_de_Formentor_108km_1930hm.gpx',
            'GGTM26_D2_B_Helios_Cap_de_Formentor_83km_1000hm.gpx',
            'GGTM26_D2_B1_Cap_de_Formentor_Helios_(tog)_40km_500hm.gpx',
            'GGTM26_D2_B2_Cap_de_Formentor_Helios_(tog)_60km_1100hm.gpx',
            'GGTM26_D3_A_Helios_Sa_Calobra__105km_1900hm.gpx',
            'GGTM26_D3_A_Sa_Calobra__Helios_100km_2300hm.gpx',
            'GGTM26_D3_B_Helios_Sa_Calobra__75km_1100hm.gpx',
            'GGTM26_D3_B1_Sa_Calobra__Helios_70km_1000hm.gpx',
            'GGTM26_D3_B2_Sa_Calobra__Helios_90km_1500hm.gpx',
            'GGTM26_D4_A_Helios_Puig_Major__72km_2400hm.gpx',
            'GGTM26_D4_A_Puig_Major_Helios_100km_1700hm.gpx',
            'GGTM26_D4_B_Helios_Puig_Major__62km_1700hm.gpx',
            'GGTM26_D4_B_Puig_Major_Helios_76km_850hm.gpx'
        ];

        function parseGPX(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            const points = [];
            const trkpts = xmlDoc.getElementsByTagName('trkpt');
            for (let i = 0; i < trkpts.length; i++) {
                const lat = parseFloat(trkpts[i].getAttribute('lat'));
                const lon = parseFloat(trkpts[i].getAttribute('lon'));
                const eleNode = trkpts[i].getElementsByTagName('ele')[0];
                const ele = eleNode ? parseFloat(eleNode.textContent) : null;
                points.push({ lat, lon, ele });
            }
            return points;
        }

        function calculateStats(points) {
            if (points.length < 2) return null;
            let distance = 0, elevationGain = 0, minEle = points[0].ele, maxEle = points[0].ele;
            for (let i = 1; i < points.length; i++) {
                const p1 = points[i - 1], p2 = points[i];
                const R = 6371;
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                distance += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                if (p1.ele !== null && p2.ele !== null) {
                    const elevDiff = p2.ele - p1.ele;
                    if (elevDiff > 0) elevationGain += elevDiff;
                }
            }
            return { distance: distance.toFixed(1), elevationGain: Math.round(elevationGain) };
        }

        async function enrichWithElevation(points) {
            console.log('üì° Enriching elevation for', points.length, 'points');
            const targetSamples = 50;
            const sampleRate = Math.max(1, Math.floor(points.length / targetSamples));
            const sampledIndices = [];
            for (let i = 0; i < points.length; i += sampleRate) sampledIndices.push(i);
            if (sampledIndices[sampledIndices.length - 1] !== points.length - 1) sampledIndices.push(points.length - 1);
            
            const locations = sampledIndices.map(i => ({ latitude: points[i].lat, longitude: points[i].lon }));
            
            try {
                const response = await fetch('https://api.open-elevation.com/api/v1/lookup', {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations })
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Elevation API returned', response.status, '- skipping elevation');
                    return false;
                }
                const data = await response.json();
                data.results.forEach((result, idx) => { points[sampledIndices[idx]].ele = result.elevation; });
                
                // Interpolate between sampled points
                for (let i = 0; i < sampledIndices.length - 1; i++) {
                    const startIdx = sampledIndices[i], endIdx = sampledIndices[i + 1];
                    const startEle = points[startIdx].ele, endEle = points[endIdx].ele;
                    for (let j = startIdx + 1; j < endIdx; j++) {
                        points[j].ele = startEle + (endEle - startEle) * ((j - startIdx) / (endIdx - startIdx));
                    }
                }
                console.log('‚úÖ Elevation enriched successfully');
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Elevation failed:', error.message, '- continuing without elevation');
                return false;
            }
        }

        function autoMakeElite() {
            days.forEach(day => day.routes = []);
            for (let dayNum = 1; dayNum <= 4; dayNum++) {
                const day = days.find(d => d.id === dayNum);
                if (!day) continue;
                const dayARoutes = routes.filter(r => {
                    const match = r.fileName.match(/GGTM26_D(\d+)_A_/);
                    if (!match || parseInt(match[1]) !== dayNum) return false;
                    const afterA = r.fileName.split('_A_')[1];
                    return afterA && !afterA.match(/^[12]/);
                });
                if (dayARoutes.length >= 2) {
                    const utRoute = dayARoutes.find(r => r.fileName.includes('Helios_'));
                    const hjemRoute = dayARoutes.find(r => !r.fileName.includes('Helios_') && r.fileName.includes('_Helios'));
                    if (utRoute && hjemRoute) day.routes.push(utRoute.id, hjemRoute.id);
                    else dayARoutes.slice(0, 2).forEach(route => day.routes.push(route.id));
                }
            }
            updateUI();
            updateMapVisibility();
            closeMenu();
            alert('‚úÖ Elite (A) ruter lastet!');
        }

        function autoMakeMosjonist() {
            days.forEach(day => day.routes = []);
            for (let dayNum = 1; dayNum <= 4; dayNum++) {
                const day = days.find(d => d.id === dayNum);
                if (!day) continue;
                
                // Find all B routes for this day (B, B1, B2)
                const allBRoutes = routes.filter(r => {
                    const match = r.fileName.match(/GGTM26_D(\d+)_B/);
                    return match && parseInt(match[1]) === dayNum;
                });
                
                // Separate B from B1/B2
                const pureB = allBRoutes.filter(r => {
                    const afterD = r.fileName.split(`GGTM26_D${dayNum}_`)[1];
                    return afterD && afterD.startsWith('B_');
                });
                
                const b1b2 = allBRoutes.filter(r => {
                    return r.fileName.includes(`_B1_`) || r.fileName.includes(`_B2_`);
                });
                
                if (pureB.length >= 1) {
                    // We have B routes - prefer these
                    const utRoute = pureB.find(r => r.fileName.includes('Helios_'));
                    const hjemRoute = pureB.find(r => !r.fileName.includes('Helios_') && r.fileName.includes('_Helios'));
                    
                    if (utRoute && hjemRoute) {
                        day.routes.push(utRoute.id, hjemRoute.id);
                    } else if (pureB.length >= 2) {
                        // If can't find UT/HJEM pattern, take first two B
                        pureB.slice(0, 2).forEach(route => day.routes.push(route.id));
                    } else if (pureB.length === 1 && b1b2.length >= 1) {
                        // 1 B route + 1 from B1/B2
                        day.routes.push(pureB[0].id, b1b2[0].id);
                    }
                } else if (b1b2.length >= 2) {
                    // No B routes, use B1 + B2
                    b1b2.slice(0, 2).forEach(route => day.routes.push(route.id));
                }
            }
            updateUI();
            updateMapVisibility();
            closeMenu();
            alert('‚úÖ Mosjonist (B) ruter lastet!');
        }

        function downloadDayGPX(dayId) {
            const day = days.find(d => d.id === dayId);
            if (!day || day.routes.length === 0) { alert('Ingen ruter valgt!'); return; }
            const dayRoutes = day.routes.map(routeId => routes.find(r => r.id === routeId)).filter(r => r);
            if (!dayRoutes[0] || !dayRoutes[0].gpxPoints) { alert('GPX-punkter mangler.'); return; }
            let allPoints = [];
            dayRoutes.forEach(route => { if (route.gpxPoints) allPoints = allPoints.concat(route.gpxPoints); });
            let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="G√•pings Mallorca Getaway" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata><n>Dag ${dayId}</n></metadata><trk><n>Dag ${dayId}</n><trkseg>
`;
            allPoints.forEach(point => {
                gpxContent += `      <trkpt lat="${point.lat}" lon="${point.lon}">`;
                if (point.ele !== null && point.ele !== undefined) gpxContent += `<ele>${point.ele}</ele>`;
                gpxContent += `</trkpt>
`;
            });
            gpxContent += `    </trkseg></trk></gpx>`;
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dag_${dayId}_Mallorca.gpx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        let map, currentDay = 0;
        
        // Init map
        map = L.map('map').setView([39.6, 2.9], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        // Menu toggle
        document.getElementById('menuBtn').onclick = () => {
            document.getElementById('menu').classList.toggle('active');
            document.getElementById('menuBtn').classList.toggle('active');
        };
        function closeMenu() {
            document.getElementById('menu').classList.remove('active');
            document.getElementById('menuBtn').classList.remove('active');
        }
        
        // Swipe - simplified version
        let startX = 0;
        const swiper = document.querySelector('.day-swiper');
        const cards = document.getElementById('dayCards');
        
        console.log('üéØ SWIPE SETUP:', { swiper: !!swiper, cards: !!cards });
        
        swiper.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            console.log('üëÜ TOUCHSTART at', startX);
        });
        
        swiper.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            console.log('üèÅ TOUCHEND:', { start: startX, end: endX, diff, currentDay });
            
            if (Math.abs(diff) < 50) {
                console.log('‚ùå Too short');
                return;
            }
            
            if (diff > 0 && currentDay < 3) {
                currentDay++;
                console.log('‚û°Ô∏è Next day:', currentDay);
            } else if (diff < 0 && currentDay > 0) {
                currentDay--;
                console.log('‚¨ÖÔ∏è Prev day:', currentDay);
            }
            updateSwiper();
        });
        
        function goToDay(dayIndex) {
            console.log('üéØ goToDay:', currentDay, '‚Üí', dayIndex);
            currentDay = dayIndex;
            updateSwiper();
        }
        
        function updateSwiper() {
            console.log('üîÑ updateSwiper - currentDay:', currentDay);
            cards.style.transform = `translateX(-${currentDay * 100}%)`;
            const dots = document.querySelectorAll('.dot');
            console.log('üîç Found dots:', dots.length);
            dots.forEach((dot, i) => {
                const isActive = i === currentDay;
                dot.classList.toggle('active', isActive);
                console.log(`  Dot ${i}: ${isActive ? 'ACTIVE' : 'inactive'}`);
            });
            updateMapVisibility();
            console.log('‚úÖ updateSwiper complete');
        }
        
        function updateMapVisibility() {
            const day = days[currentDay];
            const selectedRoutes = day.routes.map(id => routes.find(r => r.id === id)).filter(r => r);
            
            routes.forEach(route => {
                const isSelected = selectedRoutes.some(r => r.id === route.id);
                
                // Update polyline
                route.polyline.setStyle({ opacity: isSelected ? 0.7 : 0 });
                
                // Update markers - use setOpacity for CircleMarker
                if (isSelected) {
                    route.startMarker.setStyle({ fillOpacity: 0.8, opacity: 1 });
                    route.endMarker.setStyle({ fillOpacity: 0.8, opacity: 1 });
                } else {
                    route.startMarker.setStyle({ fillOpacity: 0, opacity: 0 });
                    route.endMarker.setStyle({ fillOpacity: 0, opacity: 0 });
                }
            });
            
            if (selectedRoutes.length > 0) {
                const bounds = L.featureGroup(selectedRoutes.map(r => r.polyline)).getBounds();
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }
        
        function openRouteSelector() {
            const modal = document.getElementById('routeModal');
            const selector = document.getElementById('routeSelector');
            const dayNum = currentDay + 1;
            document.getElementById('modalDayTitle').textContent = `Dag ${dayNum}`;
            
            // Filter routes for current day only
            const dayRoutes = routes.filter(r => {
                const match = r.fileName.match(/GGTM26_D(\d+)_/);
                return match && parseInt(match[1]) === dayNum;
            });
            
            selector.innerHTML = '';
            dayRoutes.forEach(route => {
                const isSelected = days[currentDay].routes.includes(route.id);
                const div = document.createElement('div');
                div.className = `route-option ${isSelected ? 'selected' : ''}`;
                
                // Parse: GGTM26_D1_A_Helios_Port_de_Soller_107km_1800hm.gpx
                const parts = route.fileName.replace('.gpx', '').split('_');
                
                // Extract level (A, B, A1, B2, etc) - it's after DX
                let level = '';
                let levelIndex = -1;
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i].match(/^D\d+$/)) {
                        level = parts[i + 1];
                        levelIndex = i + 1;
                        break;
                    }
                }
                
                // Extract locations between level and km/hm
                const locationParts = [];
                for (let i = levelIndex + 1; i < parts.length; i++) {
                    if (parts[i].match(/^\d+km$/) || parts[i].match(/^\d+hm$/)) break;
                    locationParts.push(parts[i]);
                }
                
                // Build location string: find "Helios" to determine direction
                let fromTo = locationParts.join(' ');
                const heliosIndex = locationParts.indexOf('Helios');
                
                if (heliosIndex !== -1) {
                    // Helios is present
                    if (heliosIndex === 0) {
                        // Helios first: Helios > Destination
                        const destination = locationParts.slice(1).join(' ');
                        fromTo = `Helios > ${destination}`;
                    } else {
                        // Helios last: Origin > Helios
                        const origin = locationParts.slice(0, heliosIndex).join(' ');
                        fromTo = `${origin} > Helios`;
                    }
                }
                
                const name = `${fromTo} (${level})`;
                const km = route.stats ? route.stats.distance : '?';
                const hm = route.stats ? route.stats.elevationGain : '?';
                
                div.innerHTML = `
                    <input type="checkbox" id="route-${route.id}" ${isSelected ? 'checked' : ''}>
                    <label for="route-${route.id}">
                        <div class="route-name">${name}</div>
                        <div class="route-details">${km} km | ‚¨ÜÔ∏è ${hm} m</div>
                    </label>
                `;
                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = div.querySelector('input');
                        const checked = document.querySelectorAll('.route-option input:checked').length;
                        if (!checkbox.checked && checked >= 2) {
                            alert('Maks 2 ruter per dag!');
                            return;
                        }
                        checkbox.checked = !checkbox.checked;
                        div.classList.toggle('selected', checkbox.checked);
                    } else {
                        const checked = document.querySelectorAll('.route-option input:checked').length;
                        if (e.target.checked && checked > 2) {
                            e.target.checked = false;
                            alert('Maks 2 ruter per dag!');
                            return;
                        }
                        div.classList.toggle('selected', e.target.checked);
                    }
                };
                selector.appendChild(div);
            });
            
            modal.classList.add('active');
        }
        
        function closeRouteSelector() {
            document.getElementById('routeModal').classList.remove('active');
        }
        
        function saveRouteSelection() {
            const selected = Array.from(document.querySelectorAll('.route-option input:checked'))
                .map(cb => parseInt(cb.id.split('-')[1]));
            
            days[currentDay].routes = selected;
            updateUI();
            updateMapVisibility();
            closeRouteSelector();
        }
        
        function addRoute(fileName, points, color) {
            const latLngs = points.map(p => [p.lat, p.lon]);
            const polyline = L.polyline(latLngs, { color, weight: 3, opacity: 0.7 }).addTo(map);
            const startMarker = L.circleMarker(latLngs[0], { radius: 6, fillColor: '#2ecc71', color: '#27ae60', weight: 2, fillOpacity: 0.8 }).addTo(map);
            const endMarker = L.circleMarker(latLngs[latLngs.length-1], { radius: 6, fillColor: '#e74c3c', color: '#c0392b', weight: 2, fillOpacity: 0.8 }).addTo(map);
            
            routes.push({
                id: routes.length,
                fileName,
                gpxPoints: points,
                polyline,
                startMarker,
                endMarker,
                color,
                originalColor: color,
                stats: calculateStats(points),
                visible: true
            });
            
            if (routes.length === 1) map.fitBounds(polyline.getBounds());
            updateUI();
        }
        
        function updateUI() {
            days.forEach((day, idx) => {
                const dayRoutes = day.routes.map(id => routes.find(r => r.id === id)).filter(r => r);
                let km = 0, hm = 0;
                dayRoutes.forEach(r => { if(r.stats) { km += parseFloat(r.stats.distance); hm += r.stats.elevationGain; } });
                
                document.getElementById(`day${idx+1}stats`).textContent = dayRoutes.length ? `${km.toFixed(1)} km | ‚¨ÜÔ∏è ${hm} m` : '';
                document.getElementById(`day${idx+1}routes`).innerHTML = dayRoutes.map(r => 
                    `<div class="route-chip" style="border-left-color:${r.color}">${r.fileName.split('_').slice(3,5).join(' ')}</div>`
                ).join('');
                
                // Update route colors
                dayRoutes.forEach(r => r.polyline.setStyle({ color: day.color }));
            });
        }
        
        async function loadBundledRoutes() {
            const splashFill = document.getElementById('splashFill');
            const splashText = document.getElementById('splashText');
            
            for (let i = 0; i < bundledRouteFiles.length; i++) {
                const fileName = bundledRouteFiles[i];
                splashText.textContent = `${i+1} av ${bundledRouteFiles.length} - ${fileName.substring(0, 30)}...`;
                
                try {
                    const response = await fetch(`routes/${encodeURIComponent(fileName)}`);
                    const gpxContent = await response.text();
                    const points = parseGPX(gpxContent);
                    
                    const hasElevation = points.some(p => p.ele !== null);
                    console.log(`üìä ${fileName}: ${hasElevation ? '‚úÖ HAS' : '‚ùå NO'} elevation data (${points.length} points)`);
                    
                    if (!hasElevation) {
                        console.log('üîÑ Fetching elevation from API...');
                        await enrichWithElevation(points);
                    } else {
                        console.log('‚úÖ Using GPX elevation data');
                    }
                    
                    addRoute(fileName, points, colors[routes.length % colors.length]);
                } catch (error) {
                    console.error(`Failed: ${fileName}`);
                }
                
                splashFill.style.width = `${((i+1) / bundledRouteFiles.length) * 100}%`;
            }
            
            splashText.textContent = 'Ferdig!';
            setTimeout(() => document.getElementById('splash').classList.add('hidden'), 500);
        }
        
        document.getElementById('gpxInput').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            document.getElementById('splash').classList.remove('hidden');
            const splashFill = document.getElementById('splashFill');
            const splashText = document.getElementById('splashText');
            
            for (let i = 0; i < files.length; i++) {
                splashText.textContent = `${i+1} av ${files.length} - ${files[i].name}`;
                const content = await files[i].text();
                const points = parseGPX(content);
                if (!points.some(p => p.ele !== null)) await enrichWithElevation(points);
                addRoute(files[i].name, points, colors[routes.length % colors.length]);
                splashFill.style.width = `${((i+1) / files.length) * 100}%`;
            }
            
            setTimeout(() => document.getElementById('splash').classList.add('hidden'), 500);
            e.target.value = '';
        };
        
        function clearAll() {
            routes.forEach(r => { r.polyline.remove(); r.startMarker.remove(); r.endMarker.remove(); });
            routes.length = 0;
            days.forEach(d => d.routes = []);
            updateUI();
        }
        
        function downloadCurrentDay() {
            downloadDayGPX(currentDay + 1);
        }
        
        loadBundledRoutes();
    </script>
</body>
</html>
